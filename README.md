# ПОЛЗУНКИ

Браузерная аркадная гонка змей (текущий этап: офлайн MVP + расширенная отладка).

## Текущее состояние

- Рендер и игровой цикл на `Phaser 3`.
- Фоновая музыка на первой трассе (`canyon_loop`): `assets/sounds/Formula1.mp3`.
- Переключаемые офлайн-режимы:
- `Классика`: `1 игрок + 3 бота`.
- `Отладка`: `4 бота` на автопилоте.
- Экраны: `Main Menu`, `Snake Select`, `Track Select`, `Race HUD`, `Results`.
- Active in this build: 3 synced tracks (`canyon_loop`, `switchback_run`, `twin_fang`). Other tracks are temporarily disabled until manual markup is ready.
- Добавлены новые трассы:
- `volcano_spiral` — плотные дуги и волнообразные связки.
- `glacier_chicane` — длинные прямые с быстрыми шиканами.
- 4 типа змей с разными характеристиками.
- 4 основных пикапа: `BOOST`, `SHIELD`, `OIL`, `BOMB`.
- Активная способность: плевок ядом (`Space` для игрока, автоприменение у ботов).
- Заголовок использует локальный шрифт из ассетов: `assets/font/SnakeRegular.ttf`.
- Заголовок игры анимирован как «ползущий» логотип: увеличен, центрирован и в режиме гонки слегка перекрывает карту.
- Для букв логотипа добавлен псевдо-3D стиль (градиент + объемная тень).
- Скорость «ползания» логотипа по горизонтали автоматически подстраивается под среднюю длительность заезда (берется скользящее среднее завершенных гонок, с небольшим запасом по времени).
- Логика поверхности:
- `road` — обычное движение.
- `offroad` — заметное замедление (усилено).
- `outside` — экстремальное замедление и мягкий автовозврат к траектории, без телепорта и без полной остановки.
- Визуал трассы переведен в более «живой» стиль: теплые оттенки травы, земли и асфальта.
- Фазы заезда: `Отсчет -> Гонка -> Финиш`.
- Локальная таблица лучших времен по трассам (`localStorage`).

## Новые механики тела змеи

- У каждой змеи есть сегментированное тело.
- Стартовая длина у всех змей: `8` сегментов.
- Визуальный размер сегментов тела увеличен на `50%` для лучшей читаемости.
- Тело извивается в движении.
- Для каждого типа змеи свой профиль извивки:
- разный шаг между сегментами;
- разная амплитуда волны;
- разная частота и скорость волны;
- разная “толщина” хвоста.
- Правило истощения:
- каждые `12` секунд без еды змея теряет `1` сегмент;
- если сегментов меньше `4`, змея движется очень медленно;
- каждый шаг голода дополнительно снижает скорость;
- после `3` шагов голода подряд змея не выбывает, а переходит в режим `ползком` (держит минимальный ход);
- кактусы и укусы хвоста уменьшают длину, но не увеличивают счетчик истощения.

## Дополнительные случайные объекты на трассе

- Добавлены рандомные `яблоки` и `кактусы`.
- Во время гонки они спавнятся в случайных точках на дороге и респавнятся после подбора.
- Эффект подбора:
- `яблоко` увеличивает длину тела на `+1` сегмент;
- `кактус` уменьшает длину тела мягче: примерно в `66%` случаев снимает `-1` сегмент (в среднем влияние снижено на треть).
- Яблоко также сбрасывает счетчик истощения и дает короткий сильный рывок.
- Поведение ботов: по ходу движения боты стараются подбирать `яблоки`, если они находятся впереди по траектории и в достижимом радиусе.
- Чем голоднее бот (выше счетчик голода), тем сильнее его тянет к `яблокам`: он агрессивнее смещает траекторию к яблоку и готов брать более дальние цели.
- Боты теперь заметно сильнее уводят траекторию от `BOMB` и `CACTUS`, если опасность находится впереди по ходу.
- У ботов добавлена осторожность к краю трассы: при риске вылета они заранее подтормаживают и сильнее подруливают обратно в безопасную зону.
- `BOMB` ослаблена: уменьшены радиус поражения и длительность дебафа.
- При попадании `BOMB` теперь отнимает `1` сегмент тела и замедляет, но не останавливает змею до нуля.
- После попадания `BOMB` действует короткая защита от повторного попадания подряд, чтобы избежать «вечного залипания».
- Яблоки не размещаются в плотной зоне старта/финиша, и боты не выбирают яблоко как цель в этой зоне, чтобы убрать массовые клины в одной точке.
- Спавн яблок/кактусов разнесен (без плотных наложений и без близкой постановки к чекпоинтам/пикапам), чтобы боты не клинили в одной точке.

### Таблица: объекты, бафы и дебафы на трассе

| Название | Форма | Цвет | Размер | Эффект | Время эффекта |
|---|---|---|---|---|---|
| `BOOST` | Ромб (пикап) | Ярко-зелёный | Подбор: `radius=12` (визуал ромб ~`14x14`) | Баф скорости и разгона (`speed x1.34`, `accel x1.18`) | `2600 ms` |
| `SHIELD` | Ромб (пикап) | Небесно-голубой | Подбор: `radius=12` (визуал ромб ~`14x14`) | Щит: `1` заряд, блокирует 1 негативный эффект/удар | До `6500 ms` или до срабатывания |
| `OIL` | Ромб (пикап) | Янтарно-оранжевый | Подбор: `radius=12` (визуал ромб ~`14x14`) | Дебаф управления/разгона (`turn x0.64`, `accel x0.82`) | `2200 ms` |
| `BOMB` | Ромб (пикап) + радиус взрыва | Кораллово-розовый | Подбор: `radius=12`, зона взрыва: `radius=86` | `-1` сегмент тела + `BOMB_SLOW` (`speed x0.84`, `accel x0.86`, `turn x0.93`), без полной остановки | `1450 ms` + защита от повторного попадания `1200 ms` |
| `APPLE` | Яблоко | Красно-розовый | Объект: `radius=11` | `+1` сегмент тела, сброс шага голода, мгновенный толчок скорости + краткий баф (`speed x1.48`, `accel x1.34`) | `680 ms` (рывок) |
| `CACTUS` | Кактус | Травяной зелёный | Объект: `radius=11` | в `66%` случаев: `-1` сегмент тела (в среднем `-0.67`) | Мгновенно |

## Контакт с телами змей

- Переползание через тело другой змеи замедляет.
- `handler` при переползании через чужое тело, наоборот, ускоряется.
- `trickster` не имеет иммунитета к замедлению от переползания.
- `speedster` не может переползать через чужие тела (получает блок и отталкивание).
- `bully` при контакте отталкивает соперника примерно на один сегмент и сам не замедляется от этого столкновения.
- `trickster` может откусить `1` сегмент при касании хвоста другой змеи (с небольшим кулдауном между укусами).
- Усилено антизалипание: если змея теряет прогресс и почти стоит, включается авто-вывод вперед по траектории.
- Добавлен жёсткий anti-deadlock: если змея шевелится, но не набирает прогресс по трассе, включается усиленный принудительный вывод вперед с увеличенной «призрачной» защитой.
- После пересечения финиша змея больше не замирает в точке: она продолжает ехать по треку в режиме мягкого coasting, чтобы не выглядеть как «застрявшая».
- Для `speedster` улучшен выход из блокировки на чужом теле, чтобы не зависать в правых поворотах.

## Спрайты змей

- Поддерживается подключение спрайтов головы и сегментов тела для каждого типа змеи.
- Путь к файлам:
- `assets/sprites/snakes/speedster/head.png`
- `assets/sprites/snakes/speedster/segment.png`
- `assets/sprites/snakes/handler/head.png`
- `assets/sprites/snakes/handler/segment.png`
- `assets/sprites/snakes/bully/head.png`
- `assets/sprites/snakes/bully/segment.png`
- `assets/sprites/snakes/trickster/head.png`
- `assets/sprites/snakes/trickster/segment.png`
- Если у типа змеи спрайтов нет, автоматически используется текущий векторный рендер (игра не ломается).

## Влияние длины тела на эффекты

- При увеличении тела усиливаются полезные бафы (например, `BOOST`).
- При уменьшении тела ослабляются вредные эффекты (`OIL`, `BOMB_SLOW`).
- Текущая длина тела отображается в HUD рядом с активным эффектом.

## Перки, бафы и дебафы (полный список)

- `speedster`: самая высокая скорость; не переползает чужие тела; минимальная дальность яда.
- `handler`: лучший контроль в поворотах; ускоряется при переползании через чужое тело; средняя дальность яда.
- `bully`: тяжёлый корпус и отталкивание соперника; сильный контактный контроль; дальность яда выше средней.
- `trickster`: может откусывать сегмент хвоста соперника; дальний яд.
- `BOOST`: временный баф скорости/разгона.
- `SHIELD`: 1 заряд щита, блокирует один негативный эффект/удар.
- `OIL`: дебаф управления и разгона.
- `BOMB`: радиусный удар (`-1` сегмент тела) + дебаф замедления (ослаблен; добавлена короткая защита от повторного цепного попадания), без полной остановки.
- `VENOM_SLOW` (яд): змеи могут плеваться ядом; у каждого типа своя дальность/кулдаун/сила замедления.
- `яблоко`: +1 сегмент тела, сброс шага голода, сильный короткий рывок (`680 ms`).
- `кактус`: в `66%` случаев `-1` сегмент тела (в среднем `-0.67`).
- Истощение: каждые 12 секунд без яблока -1 сегмент; змея не умирает от голода, а всё сильнее замедляется и после 3 тиков ползёт на минимальной скорости.

### Таблица: перки типов змей

| Название | Форма | Цвет | Размер | Эффект | Время эффекта |
|---|---|---|---|---|---|
| `speedster` | Змея (голова + сегменты) | Ярко-бирюзовый | База тела в гонке: `8` сегментов | Самая высокая скорость; не переползает через чужие тела (получает блок/отталкивание); яд с наименьшей дальностью (`range=128`) | Пассивно всю гонку; яд: `1450 ms`, КД `2650 ms` |
| `handler` | Змея (голова + сегменты) | Салатовый | База тела в гонке: `8` сегментов | Лучший контроль; при переползании через чужое тело ускоряется (`x1.08`, до `1.18` от max speed); яд средней дальности (`range=168`) | Пассивно всю гонку; яд: `1650 ms`, КД `2450 ms` |
| `bully` | Змея (голова + сегменты) | Лососевый | База тела в гонке: `8` сегментов | При столкновении отталкивает соперника (~`8` px) и сам не получает обычный штраф столкновения; яд выше средней дальности (`range=182`) | Пассивно всю гонку; яд: `1800 ms`, КД `2520 ms` |
| `trickster` | Змея (голова + сегменты) | Лавандовый | База тела в гонке: `8` сегментов | Может откусывать хвост (`-1` сегмент, КД укуса `900 ms`); самый дальний яд (`range=212`) | Пассивно всю гонку; яд: `1900 ms`, КД `2200 ms` |

## Управление

- `W/A/S/D` или стрелки — движение (в режиме `Классика`).
- `Space` — плевок ядом.
- `R` — быстрый рестарт текущей трассы (работает по текущему активному заезду).

## Размер игрового окна

- Игровая область (`race-stage`) увеличена еще сильнее: на десктопе почти на весь экран (порядка `95%` ширины), на мобильных - максимально крупно без ручного zoom.

## Последние фиксы стабильности

- Кнопка `Следующая трасса` после финиша теперь гарантированно запускает именно следующую трассу, а не повторно текущую.
- Анти-залипание применяется ко всем змеям; при принудительном выводе вперед (`unstuck`) сбрасывается локальная история хвоста, чтобы не было "перевернутого" тела.
- Ориентация головы привязана к фактическому вектору движения, а сегменты хвоста рендерятся в противоположную сторону движения.
- HUD внутри окна гонки сделан компактнее (уменьшены карточки, шрифты и отступы), чтобы не перекрывать траекторию.
- Закрыт фриз на переходе `Финиш -> Результаты -> Следующая трасса`: рендер больше не пытается рисовать гонку после того, как `state.race` уже очищен/заменён в том же кадре.
- Для online-режима подготовка leaderboard в Nakama расширена на все доступные трассы, чтобы результаты не терялись на новых картах.
- Match-server теперь помечает результат как отправленный только после успешного RPC и автоматически ретраит отправку при временных ошибках.
- RPC `submit_race_time` в Nakama принимает оба формата payload (JSON-объект и JSON-строка), что убирает хрупкость по сериализации между сервисами.
- Дополнительно уменьшен размер верхних HUD-карточек (`Время`/`Скорость`), чтобы они меньше перекрывали трассу.
- Убран телепорт змей при выезде за самый край трассы: вместо сброса на чекпоинт применяется сильное замедление и плавный возврат на трек при сохранении движения.
- Усилен автопилот НПС: более агрессивный обход `BOMB`/`CACTUS` и более ранняя стабилизация у кромки трассы (торможение + доворот), чтобы реже съезжать наружу.
- Отключена автопауза симуляции при потере фокуса/скрытии вкладки: боты и гонка продолжают обновляться в фоне (с учетом ограничений таймеров браузера).
- Статистика средней длительности заезда теперь синхронизируется с локальным JSON-файлом на match-server (fallback на `localStorage` сохраняется).
- Дополнительно усилено избегание кромки трассы у ботов: реакция начинается раньше, выше приоритет возврата в центр и сильнее авто-торможение при риске вылета.
- Исправлен сбой инициализации заголовка, который мог блокировать `bootstrap`: кнопки переходов и старта снова корректно запускают игру.
- Горизонтальное «ползание» заголовка дополнительно замедлено примерно в `4x`, чтобы он не пробегал экран много раз за один заезд, но оставался живее.
- Горизонтальное движение заголовка включено только на экране гонки; в меню он остается строго по центру и показывает только волновое движение букв.
- В режиме гонки заголовок прижат прямо к верхней кромке игрового поля (как будто ползет по границе экрана), с минимальным заходом внутрь трассы.
- В режиме гонки старт горизонтального ползания заголовка начинается сразу из левого угла игрового поля.
- Информационный текст трассы/фазы перенесен вниз по центру, чтобы верхние HUD-блоки (`Время`/`Скорость`) не перекрывали полезные подписи.
- Обратный отсчет перед стартом переработан: цифры `3/2/1` цветные, поочередно появляются и резко увеличиваются до масштаба экрана с исчезновением.

## Docker Compose стек

Проект собран в переносимый стек сервисов:

- `web` — фронтенд (Nginx, статика игры).
- `match-server` — Colyseus authoritative match-server.
- `nakama` — backend для leaderboard/RPC.
- `postgres` — база данных Nakama.
- Поток результатов: `match-server -> nakama RPC submit_race_time -> leaderboard`.
- Для офлайн `userId` match-server генерирует детерминированный `owner_id` (UUID), чтобы Nakama корректно записывал результаты.
- `postgres` работает только во внутренней сети `docker-compose` (порт наружу не пробрасывается).
- Данные Postgres пишутся в папку проекта `./_data/postgres` (bind mount), поэтому не теряются при перезапуске Docker/контейнеров.
- Локальная статистика длительности заездов пишется match-server в `./_data/match-server/race-duration-stats.json` (API: `/local-stats/race-duration`).

## Запуск через Docker (рекомендуется)

1. Скопировать переменные окружения:

```bash
cp .env.example .env
```

По умолчанию БД хранится в папке `./_data/postgres` внутри проекта.

2. Поднять весь стек:

```bash
docker compose up --build
```

3. Сервисы будут доступны:

- Игра: `http://localhost:5500` (дополнительно доступна на `http://localhost:8080`)
- Match-server health: `http://localhost:2567/healthz`
- Nakama API: `http://localhost:7350`
- Nakama Console: `http://localhost:7351`
- Логин в Nakama Console: из `.env` (`NAKAMA_ADMIN_USER` / `NAKAMA_ADMIN_PASSWORD`)

4. Остановить стек:

```bash
docker compose down
```

Полный сброс с удалением тома БД:

```bash
docker compose down -v
```

Для bind mount (`POSTGRES_DATA_DIR`) команда выше не удаляет файлы БД в папке хоста.
Для bind mount `./_data/postgres` команда выше не удаляет файлы БД в папке проекта.

Если на macOS видишь ошибку `dependency postgres failed to start`, проверь, что `./_data/postgres` пустая при первом запуске (без `.gitkeep` и прочих файлов), затем подними Postgres заново:

```bash
rm -f ./_data/postgres/.gitkeep
docker compose up -d postgres
docker compose logs --tail=80 postgres
```

## Локальный запуск без Docker (опционально)

Этот режим нужен только для быстрого офлайн-прогона фронтенда без серверной части.

1. Открыть терминал в корне проекта (`.../_hackathon`).
2. Запустить сервер одним из способов:

```bash
python -m http.server 5500
```

или

```bash
npx serve . -l 5500
```

3. Открыть в браузере `http://localhost:5500`.
4. Нажать `Play Offline`.
5. Выбрать режим (`Классика` или `Отладка`) и змею.
6. Нажать `Старт`.

Быстрый вариант для черновой проверки: можно открыть `index.html` напрямую, но для стабильной работы спрайтов и ассетов лучше использовать сервер.

## Правило по документации

- Все новые игровые механики и заметные изменения фиксируются в этом `README.md` сразу после реализации.
- План целевой модульной структуры фронтенда вынесен в `ARCHITECTURE.md`.
- Подробная оффлайн-архитектура игры (со схемами и графиками) вынесена в `OFFLINE_ARCHITECTURE.md`.
- Отдельное описание и схема онлайн-архитектуры вынесены в `ONLINE_ARCHITECTURE.md`.
- Пошаговый запуск online-режима и условия для 2+ игроков вынесены в `RUN_ONLINE.md`.
- 2026-02: Убран результат DNF/«сход». Итоговый рейтинг теперь формируется всегда по прогрессу, а незавершившие показываются через метрику `CP + расстояние до следующего чекпоинта`.
- Расшифровка прогресса в результатах: `CP 5 | next 236px` означает, что змея прошла `5` чекпоинтов, и до следующего чекпоинта ей осталось `236` пикселей по прямой.
- 2026-02: Anti-stall переведен на мягкое восстановление без coordinate snap: без прямых `x/y`-телепортов, только доворот + восстановление скорости + ghost-window.
- 2026-02: Шаг фронтенд-модульности 1: общие константы вынесены в `src/game/config.js`, каталоги — в `src/game/catalog.js`, математика/утилиты — в `src/game/utils.js`.
- 2026-02: Шаг фронтенд-модульности 2: рендер вынесен в `src/game/render.js`, геометрия/проекция трассы — в `src/game/trackMath.js`.
- 2026-02: Шаг фронтенд-модульности 3: UI/глобальный state вынесены в `src/game/state.js`, статистика длительности заездов — в `src/game/raceDurationStats.js`, анимация заголовка — в `src/game/titleWave.js`.
- 2026-02: Шаг фронтенд-модульности 4: автопилот ботов и ядовая боевая логика вынесены в `src/game/ai.js` с dependency-injected API.
- 2026-02: Шаг фронтенд-модульности 5: базовая симуляция гонки (движение/эффекты/коллизии/прогресс) вынесена в `src/game/simulation.js`; в `script.js` осталась оркестрация/UI.
- 2026-02: Шаг фронтенд-модульности 6: оркестрация гонки (`updateRace`, countdown/finish-переходы, финализация результатов, управление игроком) вынесена в `src/game/raceFlow.js` через `createRaceFlowApi`.
- 2026-02: Шаг фронтенд-модульности 7: setup гонки и спавн объектов вынесены в `src/game/raceSetup.js` (`createRaceState`, генерация pickups/body-items, валидация спавна, инициализация имен/истории).
- 2026-02: Шаг фронтенд-модульности 8: HUD-рендер и подписи вынесены в `src/game/hud.js` (`updateHud`, labels прогресса, labels активных эффектов).
- 2026-02: Шаг фронтенд-модульности 9: логика Phaser-сцены/инициализации вынесена в `src/game/scene.js` (`initPhaser`, background keep-alive, синхронизация музыки трассы).
- 2026-02: Шаг фронтенд-модульности 10: flow экранов вынесен в `src/game/uiFlow.js` (переключение экранов, клавиши, карточки змей/трасс, старт/рестарт/next-track).
- 2026-02: Шаг фронтенд-модульности 11: оставшиеся core UI-хелперы вынесены в `src/game/coreUi.js` (overlay/countdown, обертки рендера, форматирование best-time, toast).
- 2026-02: Шаг фронтенд-модульности 12: bootstrap/композиция перенесены в `src/game/app.js`; `script.js` стал тонкой точкой входа и только вызывает `bootstrapApp()`.

- 2026-02: Шаг рефакторинга 13: логика тела/эффектов/голода/пикапов вынесена из `src/game/simulation.js` в `src/game/simBodySystem.js`; совместимость API симуляции сохранена.
- 2026-02: Шаг рефакторинга 14: логика прогресса/standings вынесена в `src/game/simProgress.js`; `src/game/simulation.js` сфокусирован на движении, anti-stall и коллизиях.
- 2026-02: Шаг рефакторинга 15: ИИ разделен на `src/game/aiSteering.js` (цели/избегание/control) и `src/game/venomSystem.js` (яд/снаряды/попадания); `src/game/ai.js` стал тонким фасадом.
- 2026-02: Шаг рефакторинга 16: рендер разделен на `src/game/renderWorld.js` (трасса/фон/объекты) и `src/game/renderRacers.js` (змеи/спрайты/подписи); `src/game/render.js` теперь оркестрирует эти модули.
- 2026-02: Шаг рефакторинга 17: внутренности симуляции разделены на `src/game/simMotion.js` (движение/coasting) и `src/game/simInteractions.js` (пересечения тел, anti-stall, коллизии); `src/game/simulation.js` стал тонким re-export фасадом.
- 2026-02: Шаг рефакторинга 18: внутренности тела/эффектов разделены на `src/game/simBodyCore.js` (сегменты/heading/speed-модификаторы) и `src/game/simItemEffects.js` (голод/пикапы/эффекты); `src/game/simBodySystem.js` стал тонким re-export фасадом.
- 2026-02: Шаг рефакторинга 19: steering-часть NPC разделена на `src/game/aiTargeting.js` (притяжение к яблокам/выбор целей) и `src/game/aiAvoidance.js` (избегание опасностей/края); `src/game/aiSteering.js` теперь отвечает за финальный synthesis управления.
- 2026-02: Онлайн MVP шаг-1: добавлен клиент комнаты `src/game/onlineRoomClient.js` (join/create `race`, `ready`, `input`, `ping`, обработка `snapshot`/`pong`/disconnect); кнопка `Играть онлайн` теперь включает online-flow выбора змеи/трассы и подключение к комнате.
- 2026-02: Экран гонки в online-flow теперь показывает live snapshot комнаты (фаза, RTT, позиции игроков) даже без запуска локальной офлайн-симуляции; музыка трассы в гонке учитывает `state.online.trackId`.

- 2026-02: В главном меню добавлено поле произвольного имени игрока для online-режима; имя сохраняется в localStorage браузера и автоматически подставляется при входе в комнату.
- 2026-02: Для `canyon_loop` выполнена синхронизация физической траектории с вручную нарисованным бэкдропом `assets/sprites/track/Formula1.png` (виртуальная разметка теперь совпадает с визуальной трассой).
- 2026-02: Усилено замедление при сходе с трассы (offroad/outside), а также слегка усилено и сделано более ранним избегание края трассы у ботов.

### История синхронизации скелетизации (canyon_loop)

1. Взяли исходный вручную нарисованный трек `Formula1.png` как эталон геометрии.
2. Выделили маску дорожного полотна по цвету (асфальт), отбросив траву/бордюры/фон.
3. Построили скелет дорожной области и удалили паразитные ответвления (spur-ветки), чтобы получить устойчивую центральную линию.
4. Ресемплировали центрлайн в равномерный замкнутый набор точек (фиксированная плотность по длине).
5. Преобразовали координаты из размера исходной картинки в игровой канвас (`1280x720 -> 980x620`).
6. Привязали стартовую точку центрлайна к зоне клетчатого флага (финишная область справа), чтобы чекпоинт `fraction=0` совпадал с визуальным стартом/финишем.
7. Заменили `createPoints` у первой трассы (`TRACK_DEFS.canyon_loop`) на этот центрлайн, сохранив текущие параметры ширины/чекпоинтов/пикапов.

- 2026-02: Добавлен OFFLINE_ARCHITECTURE.md с подробным описанием оффлайн-контура, state-machine, tick-пайплайна, модели данных и структурными графиками.
