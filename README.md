# Snake Drift Rush

Браузерная аркадная гонка змей (текущий этап: офлайн MVP + расширенная отладка).

## Текущее состояние

- Рендер и игровой цикл на `Phaser 3`.
- Фоновая музыка на первой трассе (`canyon_loop`): `assets/sounds/Formula1.mp3`.
- Переключаемые офлайн-режимы:
- `Классика`: `1 игрок + 3 NPC`.
- `Отладка`: `4 NPC` на автопилоте.
- Экраны: `Main Menu`, `Snake Select`, `Track Select`, `Race HUD`, `Results`.
- 3 уникальные трассы.
- 4 типа змей с разными характеристиками.
- 4 основных пикапа: `BOOST`, `SHIELD`, `OIL`, `BOMB`.
- Логика поверхности:
- `road` — обычное движение.
- `offroad` — заметное замедление (усилено).
- `outside` — сброс на последний чекпоинт + штраф по времени.
- Фазы заезда: `Countdown -> Running -> Finished`.
- Локальная таблица лучших времен по трассам (`localStorage`).

## Новые механики тела змеи

- У каждой змеи есть сегментированное тело.
- Стартовая длина у всех змей: `8` сегментов.
- Визуальный размер сегментов тела увеличен на `50%` для лучшей читаемости.
- Тело извивается в движении.
- Для каждого типа змеи свой профиль извивки:
- разный шаг между сегментами;
- разная амплитуда волны;
- разная частота и скорость волны;
- разная “толщина” хвоста.
- Правило истощения:
- каждые `12` секунд без еды змея теряет `1` сегмент;
- если сегментов меньше `4`, змея движется очень медленно;
- после `3` шагов голода подряд — `DNF (истощение)`;
- кактусы и укусы хвоста уменьшают длину, но не увеличивают счетчик истощения.

## Дополнительные случайные объекты на трассе

- Добавлены рандомные `яблоки` и `кактусы`.
- Во время гонки они спавнятся в случайных точках на дороге и респавнятся после подбора.
- Эффект подбора:
- `яблоко` увеличивает длину тела на `+1` сегмент;
- `кактус` уменьшает длину тела на `-1` сегмент.
- Яблоко также сбрасывает счетчик истощения.
- Поведение NPC: по ходу движения NPC стараются подбирать `яблоки`, если они находятся впереди по траектории и в достижимом радиусе.
- Спавн яблок/кактусов разнесен (без плотных наложений и без близкой постановки к чекпоинтам/пикапам), чтобы NPC не клинили в одной точке.

## Контакт с телами змей

- Переползание через тело другой змеи замедляет.
- `handler` при переползании через чужое тело, наоборот, ускоряется.
- `trickster` не имеет иммунитета к замедлению от переползания.
- `speedster` не может переползать через чужие тела (получает блок и отталкивание).
- `bully` при контакте отталкивает соперника примерно на один сегмент и сам не замедляется от этого столкновения.
- `trickster` может откусить `1` сегмент при касании хвоста другой змеи (с небольшим кулдауном между укусами).
- Антизалипание NPC: `speedster` и `handler` не падают в нулевую скорость и продолжают движение даже в плотных контактах на поворотах.

## Спрайты змей

- Поддерживается подключение спрайтов головы и сегментов тела для каждого типа змеи.
- Путь к файлам:
- `assets/sprites/snakes/speedster/head.png`
- `assets/sprites/snakes/speedster/segment.png`
- `assets/sprites/snakes/handler/head.png`
- `assets/sprites/snakes/handler/segment.png`
- `assets/sprites/snakes/bully/head.png`
- `assets/sprites/snakes/bully/segment.png`
- `assets/sprites/snakes/trickster/head.png`
- `assets/sprites/snakes/trickster/segment.png`
- Если у типа змеи спрайтов нет, автоматически используется текущий векторный рендер (игра не ломается).

## Влияние длины тела на эффекты

- При увеличении тела усиливаются полезные бафы (например, `BOOST`).
- При уменьшении тела ослабляются вредные эффекты (`OIL`, `BOMB_SLOW`).
- Текущая длина тела отображается в HUD рядом с активным эффектом.

## Управление

- `W/A/S/D` или стрелки — движение (в режиме `Классика`).
- `R` — быстрый рестарт текущей трассы.

## Размер игрового окна

- Игровая область (`race-stage`) увеличена еще сильнее: на десктопе почти на весь экран (порядка `95%` ширины), на мобильных — максимально крупно без ручного zoom.

## Docker Compose стек

Проект собран в переносимый стек сервисов:

- `web` — фронтенд (Nginx, статика игры).
- `match-server` — Colyseus authoritative match-server.
- `nakama` — backend для leaderboard/RPC.
- `postgres` — база данных Nakama.
- Поток результатов: `match-server -> nakama RPC submit_race_time -> leaderboard`.
- Для офлайн `userId` match-server генерирует детерминированный `owner_id` (UUID), чтобы Nakama корректно записывал результаты.
- `postgres` работает только во внутренней сети `docker-compose` (порт наружу не пробрасывается).
- Данные Postgres пишутся в папку проекта `./_data/postgres` (bind mount), поэтому не теряются при перезапуске Docker/контейнеров.

## Запуск через Docker (рекомендуется)

1. Скопировать переменные окружения:

```bash
cp .env.example .env
```

По умолчанию БД хранится в папке `./_data/postgres` внутри проекта.

2. Поднять весь стек:

```bash
docker compose up --build
```

3. Сервисы будут доступны:

- Игра: `http://localhost:5500` (дополнительно доступна на `http://localhost:8080`)
- Match-server health: `http://localhost:2567/healthz`
- Nakama API: `http://localhost:7350`
- Nakama Console: `http://localhost:7351`
- Логин в Nakama Console: из `.env` (`NAKAMA_ADMIN_USER` / `NAKAMA_ADMIN_PASSWORD`)

4. Остановить стек:

```bash
docker compose down
```

Полный сброс с удалением тома БД:

```bash
docker compose down -v
```

Для bind mount (`POSTGRES_DATA_DIR`) команда выше не удаляет файлы БД в папке хоста.
Для bind mount `./_data/postgres` команда выше не удаляет файлы БД в папке проекта.

Если на macOS видишь ошибку `dependency postgres failed to start`, проверь, что `./_data/postgres` пустая при первом запуске (без `.gitkeep` и прочих файлов), затем подними Postgres заново:

```bash
rm -f ./_data/postgres/.gitkeep
docker compose up -d postgres
docker compose logs --tail=80 postgres
```

## Локальный запуск без Docker (опционально)

Этот режим нужен только для быстрого офлайн-прогона фронтенда без серверной части.

1. Открыть терминал в корне проекта (`.../_hackathon`).
2. Запустить сервер одним из способов:

```bash
python -m http.server 5500
```

или

```bash
npx serve . -l 5500
```

3. Открыть в браузере `http://localhost:5500`.
4. Нажать `Play Offline`.
5. Выбрать режим (`Классика` или `Отладка`) и змею.
6. Нажать `Старт`.

Быстрый вариант для черновой проверки: можно открыть `index.html` напрямую, но для стабильной работы спрайтов и ассетов лучше использовать сервер.

## Правило по документации

- Все новые игровые механики и заметные изменения фиксируются в этом `README.md` сразу после реализации.
